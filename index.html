<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>MyGame</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
		  <link rel="stylesheet" href="css/infoDialog.css">
	</head>
	<body>
		<div style="position: fixed;top: 20px;width: 10em;height: 24px; background-color: grey; border: solid 2px yellow">
  			<div id = "oxyBar" style="height:24px;width:100%; background-color: red;" data-value =100></div>
		</div>

		<div id="infoBox" class="center">
			<center><h2 style="font-family: sans-serif;">Information</h2></center>
			<p id="message"></p>
		</div>

		<script src="js/three.js"></script>
		<script src="js/func.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="js/infoDialog.js"></script>
		<script>
			var scene = new THREE.Scene();
			var width = window.innerWidth;
			var height = window.innerHeight;
			// Orthographic, Keeping near at .1, as close as possible
			var camera = new THREE.OrthographicCamera( width / -2, width / 2, height / 2, height / -2, .1, 1000.0 );
			camera.lookAt(new THREE.Vector3(0,0,1));

			var renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.setClearColor(0xffffff, 1.0);
			document.body.appendChild( renderer.domElement );

			collidableMeshList = [];
			// Making bars
			collidableMeshList = collidableMeshList.concat(makeSideBars(scene));
			collidableMeshList = collidableMeshList.concat(genFloor(scene));
			var water = genWater(scene);
			var character = genCharacter(scene);
			var darknessFilter = genDarknessFilter(scene, 1);
			var movementSpeed = 5;
			var characterAccel = -0.01;
			var characterVelo = 0;

			var torchDirection = 0;

			var map = {}; // You could also use an array
			onkeydown = onkeyup = function(e){
			    e = e || event; // to deal with IE
			    map[e.keyCode] = e.type == 'keydown';
			    if(map[37]){
			    	e.preventDefault(); move(character, collidableMeshList, movementSpeed, 0);
			    	torchDirection = 0;
			    }
			    if(map[38]){
			    	e.preventDefault(); if(isInWater){characterVelo = 0; move(character, collidableMeshList, movementSpeed, 1);}
			    	torchDirection = 1.5*Math.PI;
			    }
			    if(map[39]){
			    	e.preventDefault(); move(character, collidableMeshList, -movementSpeed, 2);
			    	torchDirection = Math.PI;
			    }
			    if(map[40]){
			    	e.preventDefault(); move(character, collidableMeshList, -movementSpeed, 3);
			    	torchDirection = 0.5*Math.PI;
			    }

			    if(map[37] && map[38]){
			    	torchDirection = 1.75*Math.PI;
			    }
			    if(map[38] && map[39]){
			    	torchDirection = 1.25*Math.PI;
			    }
			    if(map[39] && map[40]){
			    	torchDirection = 0.75*Math.PI;
			    }
			    if(map[40] && map[37]){
			    	torchDirection = 0.25*Math.PI;
			    }

			}
			/*document.addEventListener("keydown", function(e){
				switch(e.keyCode) {
					// move(character, movementSpeed, collidableMeshList, 0);
					case 37: e.preventDefault(); move(character, collidableMeshList, movementSpeed, 0);  break;
					case 38: e.preventDefault(); characterVelo = 0; move(character, collidableMeshList, movementSpeed, 1); break;
					case 39: e.preventDefault(); move(character, collidableMeshList, movementSpeed, 2); break;
					case 40:  break;
				}
			}, false);*/



			//camera.position.z = 5;
			var firstBB;
			var secondBB;
			var isInWater = false;

			var percentOxy;
			var oxy;

			var animate = function () {
				requestAnimationFrame( animate );

				//cube.rotation.x += 0.1;
				//cube.rotation.y += 0.1;
				if(inWater(character, water)){
					characterVelo += characterAccel;
					if(!isInWater){
						characterVelo *= 0.1;
					}
					isInWater = true;
				}
				else{
					characterVelo += -.05;
					if(isInWater){
						
					}
					isInWater = false;
				}
				//characterVelo += characterAccel;
				move(character, collidableMeshList, characterVelo, 3);
				

				//console.log(character.position);
				//console.log(water.position);
				/*for(var i = 0;i<collidableMeshList.length;i++) {
					firstBB = new THREE.Box3().setFromObject(collidableMeshList[i]);
					secondBB = new THREE.Box3().setFromObject(character);

					var collision = firstBB.intersectsBox(secondBB);

					if((firstBB.getCenter().x - secondBB.getCenter().x)>0) {
						lockCharLeft[3] = true; //Locking left motion
					}
					if((firstBB.getCenter().x - secondBB.getCenter().x)<0) {
						lockCharLeft[2] = true; //locking right motion
					}
					if((firstBB.getCenter().y - secondBB.getCenter().y)>0) {
						lockCharLeft[0] = true; //Locking upward motion
					}
					if((firstBB.getCenter().y - secondBB.getCenter().y)<0) {
						lockCharLeft[1] = true; //Locking downward motion
					}
				}
				

				
				if(collision) lockCharLeft = 0;
				else lockCharLeft = 1;*/

				darknessFilter.position.x = character.position.x;
				darknessFilter.position.y = character.position.y;
				// console.log(torchDirection);

				darknessFilter.rotation.z = 0.8*darknessFilter.rotation.z-0.2*torchDirection;

				renderer.render(scene, camera);

				percentOxy = document.getElementById("oxyBar").style.width;
				oxy = document.getElementById("oxyBar").getAttribute('data-value');
				if(!isInWater && oxy<100) {
					oxy += 40;
					percentOxy = oxy+'%';
					document.getElementById("oxyBar").style.width = percentOxy;
					document.getElementById("oxyBar").setAttribute('data-value',oxy)
				}
				if(isInWater && oxy>0 && oxy<=100) {
					oxy = Number(oxy).toFixed(2)-  Number(0.1).toFixed(2);
					percentOxy = oxy+'%';
					document.getElementById("oxyBar").style.width = percentOxy;
					document.getElementById("oxyBar").setAttribute('data-value',oxy)
				}
				if(oxy==0) {
					document.getElementById("infoBox").style.display = "block";
					document.getElementById("message").innerHTML = "Death!";
					onkeydown = onkeyup = function(event) {
						if(event.keyCode = 27) {
							location.reload();
						}
					}

				}
				

			};

			animate();
		</script>
	</body>
</html>